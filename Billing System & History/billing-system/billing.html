<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing | RECORDS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .billing-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .billing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .billing-title {
            font-size: 1.8rem;
            color: #2196F3;
            font-weight: bold;
        }

        .customer-details, .order-items, .tax-calculation {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            background-color: #fff;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 1.4rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .items-table th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }

        .items-table td {
            padding: 12px;
            border-top: 1px solid #eee;
            text-align: left;
        }

        .items-table tr:hover {
            background-color: #f9f9f9;
        }

        .item-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .add-item {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .add-item:hover {
            background-color: #45a049;
        }

        .delete-item {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }

        .delete-item:hover {
            background-color: #d32f2f;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .save-bill {
            background: #4CAF50;
            color: white;
        }

        .print-bill {
            background: #2196F3;
            color: white;
        }

        .clear-bill {
            background: #f44336;
            color: white;
        }

        .send-whatsapp {
            background: #25D366;
            color: white;
        }

        .edit-bill {
            background: #FF9800;
            color: white;
        }

        .total-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .total-row:last-child {
            border-bottom: none;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .status-label {
            font-weight: 600;
        }

        .status-toggle {
            display: flex;
            gap: 10px;
        }

        .status-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .paid-btn {
            background-color: #4CAF50;
            color: white;
        }

        .pending-btn {
            background-color: #FF9800;
            color: white;
            border-bottom: 1px solid #ddd;
        }

        .final-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3;
        }

        /* Bill History Styles */
        .bill-history {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .history-search {
            display: flex;
            gap: 10px;
        }

        .history-search input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
        }

        .filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .history-table th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }

        .history-table td {
            padding: 12px;
            border-top: 1px solid #eee;
            text-align: left;
        }

        .history-table tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-paid {
            background-color: #e8f5e9;
            color: #4CAF50;
        }

        .status-pending {
            background-color: #fff3e0;
            color: #FF9800;
        }

        .bill-actions {
            display: flex;
            gap: 5px;
        }

        .bill-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }

        .view-btn {
            background-color: #2196F3;
            color: white;
        }

        .edit-btn {
            background-color: #FF9800;
            color: white;
        }

        .download-btn {
            background-color: #4CAF50;
            color: white;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .export-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-excel {
            background-color: #217346;
            color: white;
        }

        .export-pdf {
            background-color: #f44336;
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fdfdfd;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
            <a href="dashboard.html" class="header-brand">🍽️ RECORDS</a>
            <nav class="header-nav">
                <a href="dashboard.html" class="header-nav-item">Dashboard</a>
                <a href="orders.html" class="header-nav-item">Orders</a>
                <a href="menu.html" class="header-nav-item">Menu</a>
                <a href="tables.html" class="header-nav-item">Tables</a>
                <a href="history.html" class="header-nav-item">History</a>
                <a href="billing.html" class="header-nav-item active">Billing</a>
                <a href="feedback.html" class="header-nav-item">Feedback</a>
            </nav>
        </div>
        <div class="header-right">
            <div class="header-search">
                <input type="text" placeholder="Search orders, menu items, customers...">
                <span class="header-search-icon">🔍</span>
            </div>
            <div class="header-actions">
                <a href="orders.html" class="header-btn">
                    <span>📋</span> New Order
                </a>
                <div class="header-notifications">
                    <button class="header-btn">🔔</button>
                    <span class="notification-badge">3</span>
                </div>
                <div class="header-profile" onclick="window.location.href='profile.html'">
                    <img src="../assets/profile.jpg" alt="Profile" class="header-profile-img">
                    <div class="header-profile-info">
                        <div class="header-profile-name">Aalok Nikam</div>
                        <div class="header-profile-role">Restaurant Manager</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="sidebar"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="billing-container">
                <div class="billing-header">
                    <div class="billing-title">🧾 Create New Bill</div>
                </div>
                
                <div class="customer-details">
                    <div class="section-header">
                        <div class="section-title"><span class="section-icon">👤</span> Customer Details</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="mobileNumber">Mobile Number</label>
                            <input type="tel" id="mobileNumber" pattern="[0-9]{10}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tableNumber">Table Number</label>
                            <input type="number" id="tableNumber" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="billNumber">Bill Number</label>
                            <input type="text" id="billNumber" readonly>
                        </div>
                        <div class="form-group">
                            <label for="billDate">Date & Time</label>
                            <input type="text" id="billDate" readonly>
                        </div>
                    </div>
                </div>

                <div class="order-items">
                    <div class="section-header">
                        <div class="section-title"><span class="section-icon">📦</span> Order Items</div>
                        <div class="total-items">Total Items: <span id="totalItems">0</span></div>
                    </div>
                    <div class="form-group">
                        <div class="item-input-group">
                            <input type="text" id="itemName" placeholder="Item Name">
                            <input type="number" id="quantity" placeholder="Quantity" min="1" value="1">
                            <input type="number" id="pricePerUnit" placeholder="Price per Unit" step="0.01">
                            <button onclick="addItem()" class="add-item">Add Item</button>
                        </div>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Price per Unit (₹)</th>
                                <th>Subtotal (₹)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <div class="tax-calculation">
                    <div class="section-header">
                        <div class="section-title"><span class="section-icon">🧮</span> Tax & Total Calculation</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cgstRate">CGST Rate (%)</label>
                            <input type="number" id="cgstRate" value="9" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="sgstRate">SGST Rate (%)</label>
                            <input type="number" id="sgstRate" value="9" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>CGST:</span>
                            <span id="cgstAmount">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>SGST:</span>
                            <span id="sgstAmount">₹0.00</span>
                        </div>
                        <div class="total-row final-total">
                            <span>Final Total:</span>
                            <span id="finalTotal">₹0.00</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod" class="form-control" required>
                            <option value="CASH">💵 Cash</option>
                            <option value="UPI">📱 UPI</option>
                            <option value="CARD">💳 Card</option>
                            <option value="OTHER">🔗 Other</option>
                        </select>
                    </div>

                </div>

                <div class="action-buttons" style="display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap;">
                    <button 
                        onclick="printBill()"
                        style="
                            padding: 12px 24px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#6c757d'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <i class="fas fa-print" style="font-size: 14px;"></i>
                        Print Bill
                    </button>
                    <button 
                        onclick="sendWhatsApp()"
                        style="
                            padding: 12px 24px;
                            background: #25D366;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#128C7E'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#25D366'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <i class="fab fa-whatsapp" style="font-size: 16px;"></i>
                        Send via WhatsApp
                    </button>
                    <button 
                        id="saveBillBtn" 
                        type="button"
                        style="
                            padding: 12px 24px;
                            background: #4a6cf7;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#3a5bd9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#4a6cf7'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <i class="fas fa-rupee-sign" style="font-size: 14px;"></i>
                        Paid
                    </button>
                    <button 
                        onclick="clearBill()"
                        style="
                            padding: 12px 24px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            margin-left: auto;
                        "
                        onmouseover="this.style.backgroundColor='#c82333'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#dc3545'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <i class="fas fa-trash-alt" style="font-size: 14px;"></i>
                        Clear
                    </button>
                    <script>
                        document.getElementById('saveBillBtn').addEventListener('click', saveBill);
                    </script>
                </div>

                <!-- Bill History Section -->
                <div class="bill-history">
                    <div class="history-header">
                        <div class="history-title">🔍 Bill History</div>
                        <div class="history-actions" id="bulkActions" style="display: none; gap: 10px; margin-left: auto;">
                            <button class="btn btn-danger" onclick="deleteSelectedBills()" style="padding: 6px 12px; font-size: 14px;">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-secondary" onclick="printSelectedBills()" style="padding: 6px 12px; font-size: 14px;">
                                <i class="fas fa-print"></i> Print Selected
                            </button>
                        </div>
                        <div class="history-search">
                            <input type="text" id="historySearch" placeholder="Search by name, mobile, bill no...">
                        </div>
                    </div>
                    
                    <div class="history-filters">
                        <div class="filter-group">
                            <span class="filter-label">Date Range:</span>
                            <input type="date" id="startDate" class="filter-date">
                            <span>to</span>
                            <input type="date" id="endDate" class="filter-date">
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Status:</span>
                            <select id="statusFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAllBills" onchange="toggleSelectAllBills(this)">
                                </th>
                                <th>Bill No.</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Mobile</th>
                                <th>Table No.</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billHistory">
                            <!-- Bill history will be loaded here -->
                        </tbody>
                    </table>
                    
                    <div class="export-buttons">
                        <button class="export-btn export-excel" onclick="exportToExcel()"><span>📊</span> Export to Excel</button>
                        <button class="export-btn export-pdf" onclick="exportToPDF()"><span>📄</span> Export to PDF</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bill View/Edit Modal -->
    <div id="billModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10005; overflow-y: auto; color: #000; padding-top: 60px;">
        <div class="modal-content" style="background: #f9f9f9; margin: 20px auto; padding: 0; width: 95%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 15px 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #f9f9f9; z-index: 10; border-radius: 8px 8px 0 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <div class="modal-title" id="modalTitle" style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">Bill Details</div>
                <button class="close-modal" onclick="closeModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6c757d; padding: 0 8px 4px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#000'" onmouseout="this.style.color='#6c757d'">&times;</button>
            </div>
            <div id="modalContent" style="padding: 25px; max-height: calc(100vh - 150px); overflow-y: auto; color: #000;">
                <!-- Modal content will be loaded here -->
                <style>
                    /* Ensure all text in modal is visible */
                    #billModal,
                    #billModal * {
                        color: #000 !important;
                    }
                    /* Style for bill details sections */
                    .bill-section {
                        background: #fff;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        border: 1px solid #e0e0e0;
                    }
                    /* Style for table cells */
                    #billModal table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                    }
                    #billModal th,
                    #billModal td {
                        padding: 12px 15px;
                        text-align: left;
                        border-bottom: 1px solid #e0e0e0;
                        color: #333 !important;
                    }
                    #billModal th {
                        background-color: #f5f5f5;
                        font-weight: 600;
                        color: #2c3e50 !important;
                    }
                    #billModal tr:hover {
                        background-color: #f9f9f9;
                    }
                    /* Style for totals section */
                    .totals-section {
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 20px;
                        margin: 20px 0;
                        border: 1px solid #e0e0e0;
                    }
                    .totals-section div {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid #e0e0e0;
                        color: #000 !important;
                    }
                    .totals-section div:last-child {
                        border-bottom: none;
                        font-weight: 600;
                        font-size: 1.1em;
                        padding-top: 15px;
                        margin-top: 5px;
                        color: #2c3e50 !important;
                    }
                </style>
            </div>
        </div>
    </div>
    </div>

    <script src="../js/scripts.js"></script>
    <script>
        // Global variables
        let items = [];
        let paymentStatus = 'paid'; // Default payment status
        let currentBillId = null; // For editing existing bills
        let isEditMode = false;

        // Initialize bill number, date, and load bill history
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Load sidebar
            if (document.getElementById('sidebar')) {
                fetch('../components/sidebar.html')
                    .then(response => response.text())
                    .then(data => {
                        document.getElementById('sidebar').innerHTML = data;
                    });
            }

            // Initialize new bill
            initializeNewBill();
            
            // Load bill history
            loadBillHistory();

            // Set up event listeners
            setupEventListeners();
            
            // Debug: Check if saveBill is defined
            console.log('saveBill function exists:', typeof saveBill === 'function');
            
            // Debug: Add click handler for save button
            const saveBtn = document.getElementById('saveBillBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveBill);
                console.log('Save button click handler attached');
            } else {
                console.error('Save button not found!');
            }
        });

        window.initializeNewBill = function() {
            const now = new Date();
            const timestamp = now.getTime();
            document.getElementById('billNumber').value = `BILL${timestamp}`;
            document.getElementById('billDate').value = now.toLocaleString();
            document.getElementById('tableNumber').value = '1';
            document.getElementById('customerName').value = '';
            document.getElementById('mobileNumber').value = '';
            items = [];
            updateItemsList();
            calculateTotal();
            setPaymentStatus('paid');
            isEditMode = false;
            currentBillId = null;
        }

        function setupEventListeners() {
            // Listen for tax rate changes
            document.getElementById('cgstRate').addEventListener('change', calculateTotal);
            document.getElementById('sgstRate').addEventListener('change', calculateTotal);
            
            // Search functionality for bill history
            document.getElementById('historySearch').addEventListener('input', filterBillHistory);
            
            // Date range filter
            document.getElementById('startDate').addEventListener('change', filterBillHistory);
            document.getElementById('endDate').addEventListener('change', filterBillHistory);
            
            // Status filter
            document.getElementById('statusFilter').addEventListener('change', filterBillHistory);
            
            // Initialize bill storage if it doesn't exist
            initializeBillStorage();
        }
        
        function initializeBillStorage() {
            // Check if bill storage exists in localStorage
            const billsStorage = JSON.parse(localStorage.getItem('billsPDFStorage') || '{}');
            
            // Create folder structure if it doesn't exist
            if (!billsStorage.folders) {
                billsStorage.folders = {
                    'bills': {},
                    'history': {}
                };
                localStorage.setItem('billsPDFStorage', JSON.stringify(billsStorage));
            }
        }
        
        function viewBillStorage() {
            // Get bill storage from localStorage
            const billsStorage = JSON.parse(localStorage.getItem('billsPDFStorage') || '{}');
            
            // Create modal for viewing bill storage
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'billStorageModal';
            
            // Check if there are any bills in storage
            const hasBills = billsStorage.folders && 
                            (Object.keys(billsStorage.folders.bills || {}).length > 0 || 
                             Object.keys(billsStorage.folders.history || {}).length > 0);
            
            let modalContent = '';
            
            if (hasBills) {
                modalContent = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>Bill Management Storage</h2>
                            <span class="close-modal" onclick="closeBillStorageModal()">&times;</span>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <div style="padding: 20px;">
                                <h3>📁 Bills Folder</h3>
                                <div class="storage-files">
                                    ${generateBillFilesList(billsStorage.folders.bills || {})}
                                </div>
                                
                                <h3>📁 History Folder</h3>
                                <div class="storage-files">
                                    ${generateBillFilesList(billsStorage.folders.history || {})}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                modalContent = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Bill Management Storage</h2>
                            <span class="close-modal" onclick="closeBillStorageModal()">&times;</span>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 30px;">
                            <p>No bills have been saved yet. Save a bill to see it here.</p>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // Add styles for the storage view if not already added
            if (!document.getElementById('storageStyles')) {
                const style = document.createElement('style');
                style.id = 'storageStyles';
                style.textContent = `
                    .storage-files {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                        gap: 15px;
                        margin-bottom: 20px;
                    }
                    .storage-file {
                        background: #f9f9f9;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }
                    .storage-file:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    }
                    .storage-file-info {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .storage-file-name {
                        font-weight: bold;
                        word-break: break-all;
                        color: #333;
                        font-size: 14px;
                        border-bottom: 1px solid #eee;
                        padding-bottom: 5px;
                    }
                    .file-details {
                        font-size: 13px;
                        color: #666;
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }
                    .file-details div {
                        display: flex;
                        justify-content: space-between;
                    }
                    .storage-file-actions {
                        display: flex;
                        gap: 10px;
                        margin-top: 5px;
                    }
                    .storage-file-actions button {
                        flex: 1;
                        padding: 8px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 5px;
                        transition: background 0.2s ease;
                    }
                    .view-pdf-btn {
                        background: #2196F3;
                        color: white;
                    }
                    .view-pdf-btn:hover {
                        background: #1976D2;
                    }
                    .delete-pdf-btn {
                        background: #f44336;
                        color: white;
                    }
                    .delete-pdf-btn:hover {
                        background: #d32f2f;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function generateBillFilesList(files) {
            if (Object.keys(files).length === 0) {
                return '<p>No files in this folder.</p>';
            }
            
            let html = '';
            for (const filename in files) {
                // Extract bill details from filename
                let billDetails = '';
                const parts = filename.split('_');
                
                if (parts.length >= 3) {
                    const customerName = parts[0].replace(/_/g, ' ');
                    const mobileNumber = parts.length > 1 ? parts[1] : '';
                    const dateStr = parts.length > 2 ? parts[2] : '';
                    
                    billDetails = `
                        <div class="file-details">
                            <div><strong>Customer:</strong> ${customerName}</div>
                            <div><strong>Mobile:</strong> ${mobileNumber}</div>
                            <div><strong>Date:</strong> ${dateStr}</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="storage-file">
                        <div class="storage-file-info">
                            <div class="storage-file-name">${filename}</div>
                            ${billDetails}
                        </div>
                        <div class="storage-file-actions">
                            <button class="view-pdf-btn" onclick="viewPDF('${filename}')">🔍 View</button>
                            <button class="delete-pdf-btn" onclick="deletePDF('${filename}')">🗑️ Delete</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }
        
        function viewPDF(filename) {
            const billsStorage = JSON.parse(localStorage.getItem('billsPDFStorage') || '{}');
            
            // Check if file exists in bills folder
            let pdfData = null;
            let billInfo = null;
            let billId = null;
            
            // Extract bill ID from filename - it should be the last part before .pdf
            const filenameParts = filename.split('_');
            if (filenameParts.length > 0) {
                billId = filenameParts[filenameParts.length - 1].replace('.pdf', '');
            }
            
            // Check in all folders for the PDF data
            const folders = ['bills', 'history'];
            
            for (const folder of folders) {
                if (billsStorage.folders[folder] && billsStorage.folders[folder][filename]) {
                    pdfData = billsStorage.folders[folder][filename];
                    break;
                }
            }
            
            // Get bill details if we have a billId
            if (billId) {
                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                billInfo = bills.find(b => b.id === billId);
            }
            
            if (pdfData) {
                // If we have bill info, show it in the modal
                if (billInfo) {
                    viewBill(billInfo.id);
                } else {
                    // Try to extract customer details from filename to show in a custom modal
                    const parts = filename.split('_');
                    if (parts.length >= 3) {
                        const customerName = parts[0].replace(/_/g, ' ');
                        const mobileNumber = parts[1] || 'N/A';
                        const dateStr = parts[2] || 'N/A';
                        
                        // Create a simple modal with the extracted information
                        showBillPDFModal(filename, customerName, mobileNumber, dateStr, pdfData);
                    } else {
                        // Open PDF in new tab if we can't extract details
                        window.open(pdfData, '_blank');
                    }
                }
            } else {
                showNotification('PDF file not found', 'error');
            }
        }
        
        function showBillPDFModal(filename, customerName, mobileNumber, dateStr, pdfData) {
            // Create modal element
            const modal = document.createElement('div');
            modal.id = 'billPDFModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            // Create modal content
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Bill Details - ${filename}</h3>
                        <span class="close" onclick="document.getElementById('billPDFModal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="bill-details">
                            <div class="bill-detail-row">
                                <div class="bill-detail-label">Customer:</div>
                                <div class="bill-detail-value">${customerName}</div>
                            </div>
                            <div class="bill-detail-row">
                                <div class="bill-detail-label">Mobile:</div>
                                <div class="bill-detail-value">${mobileNumber}</div>
                            </div>
                            <div class="bill-detail-row">
                                <div class="bill-detail-label">Date:</div>
                                <div class="bill-detail-value">${dateStr}</div>
                            </div>
                        </div>
                        
                        <div class="pdf-preview">
                            <iframe src="${pdfData}" width="100%" height="500px"></iframe>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="action-btn print-btn" onclick="window.open('${pdfData}', '_blank')">🖨️ Print</button>
                            <button class="action-btn download-btn" onclick="downloadPDF('${filename}', '${pdfData}')">⬇️ Download</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.appendChild(modal);
            
            // Add styles for the modal if not already added
            if (!document.getElementById('pdfModalStyles')) {
                const style = document.createElement('style');
                style.id = 'pdfModalStyles';
                style.textContent = `
                    .pdf-preview {
                        margin: 20px 0;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        overflow: hidden;
                    }
                    .modal-actions {
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 20px;
                    }
                    .action-btn {
                        padding: 10px 20px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 1rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 5px;
                        transition: background 0.2s ease;
                    }
                    .print-btn {
                        background: #2196F3;
                        color: white;
                    }
                    .print-btn:hover {
                        background: #1976D2;
                    }
                    .download-btn {
                        background: #4CAF50;
                        color: white;
                    }
                    .download-btn:hover {
                        background: #3e8e41;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function downloadPDF(filename, pdfData) {
            // Create a link element
            const link = document.createElement('a');
            link.href = pdfData;
            link.download = filename;
            
            // Append to the document
            document.body.appendChild(link);
            
            // Trigger click
            link.click();
            
            // Clean up
            document.body.removeChild(link);
            
            showNotification(`Downloaded ${filename}`, 'success');
        }
        
        function deletePDF(filename) {
            if (confirm(`Are you sure you want to delete ${filename}?`)) {
                const billsStorage = JSON.parse(localStorage.getItem('billsPDFStorage') || '{}');
                
                // Check if file exists in all folders and delete it
                let deleted = false;
                const folders = ['bills', 'history'];
                
                for (const folder of folders) {
                    if (billsStorage.folders[folder] && billsStorage.folders[folder][filename]) {
                        delete billsStorage.folders[folder][filename];
                        deleted = true;
                    }
                }
                
                if (deleted) {
                    localStorage.setItem('billsPDFStorage', JSON.stringify(billsStorage));
                    showNotification(`Deleted ${filename}`, 'success');
                    
                    // Refresh the storage view
                    closeBillStorageModal();
                    viewBillStorage();
                } else {
                    showNotification('PDF file not found', 'error');
                }
            }
        }
        
        function closeBillStorageModal() {
            const modal = document.getElementById('billStorageModal');
            if (modal) {
                modal.style.display = 'none';
                modal.remove();
            }
        }

        function addItem() {
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const pricePerUnit = parseFloat(document.getElementById('pricePerUnit').value);

            if (!itemName || !quantity || !pricePerUnit) {
                showNotification('Please fill all item details', 'error');
                return;
            }

            const subtotal = quantity * pricePerUnit;
            items.push({ itemName, quantity, pricePerUnit, subtotal });

            updateItemsList();
            calculateTotal();
            
            // Clear input fields
            document.getElementById('itemName').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('pricePerUnit').value = '';
            document.getElementById('itemName').focus();
        }

        function removeItem(index) {
            items.splice(index, 1);
            updateItemsList();
            calculateTotal();
        }

        function updateItemsList() {
            console.log('=== updateItemsList() called ===');
            console.log('Current items array:', JSON.stringify(items, null, 2));
            
            const tbody = document.getElementById('itemsList');
            if (!tbody) {
                console.error('❌ Error: Could not find itemsList table body in the DOM');
                return;
            }
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Check if items is an array and has elements
            if (!Array.isArray(items)) {
                console.error('❌ Error: items is not an array:', items);
                return;
            }
            
            if (items.length === 0) {
                console.log('ℹ️ No items to display');
                document.getElementById('totalItems').textContent = '0';
                return;
            }
            
            console.log(`✅ Found ${items.length} items to display`);
            
            // Add each item to the table
            items.forEach((item, index) => {
                try {
                    console.log(`Processing item ${index}:`, item);
                    
                    // Validate item
                    if (!item) {
                        console.error(`❌ Item at index ${index} is null or undefined`);
                        return;
                    }
                    
                    if (typeof item !== 'object') {
                        console.error(`❌ Item at index ${index} is not an object:`, item);
                        return;
                    }
                    
                    // Ensure required properties exist
                    const itemName = item.itemName || 'Unnamed Item';
                    const quantity = item.quantity || 0;
                    const pricePerUnit = parseFloat(item.pricePerUnit) || 0;
                    const subtotal = parseFloat(item.subtotal) || (quantity * pricePerUnit);
                    
                    console.log(`Adding item ${index}: ${itemName} (Qty: ${quantity}, Price: ${pricePerUnit})`);
                    
                    // Create and append the row
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${itemName}</td>
                        <td>${quantity}</td>
                        <td>₹${pricePerUnit.toFixed(2)}</td>
                        <td>₹${subtotal.toFixed(2)}</td>
                        <td><button onclick="removeItem(${index})" class="delete-item" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button></td>
                    `;
                    
                    console.log(`✅ Successfully added item ${index} to the table`);
                } catch (error) {
                    console.error(`❌ Error adding item at index ${index}:`, error);
                    console.error('Item data:', item);
                }
            });

            // Update total items count
            const totalItemsElement = document.getElementById('totalItems');
            if (totalItemsElement) {
                totalItemsElement.textContent = items.length;
                console.log(`✅ Updated total items count to: ${items.length}`);
            } else {
                console.error('❌ Could not find totalItems element in the DOM');
            }
            
            // Force a reflow to ensure the UI updates
            setTimeout(() => {
                const visibleRows = document.querySelectorAll('#itemsList tr').length;
                console.log(`📊 Rows currently visible in the table: ${visibleRows}`);
                
                if (visibleRows !== items.length) {
                    console.warn(`⚠️ Warning: Expected ${items.length} rows, but found ${visibleRows} in the DOM`);
                    console.log('Current table HTML:', tbody.innerHTML);
                }
            }, 100);
            
            console.log('=== Finished updating items list ===');
        }

        function calculateTotal() {
            const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
            const cgstRate = parseFloat(document.getElementById('cgstRate').value) / 100;
            const sgstRate = parseFloat(document.getElementById('sgstRate').value) / 100;

            const cgstAmount = subtotal * cgstRate;
            const sgstAmount = subtotal * sgstRate;
            const finalTotal = subtotal + cgstAmount + sgstAmount;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('cgstAmount').textContent = `₹${cgstAmount.toFixed(2)}`;
            document.getElementById('sgstAmount').textContent = `₹${sgstAmount.toFixed(2)}`;
            document.getElementById('finalTotal').textContent = `₹${finalTotal.toFixed(2)}`;
        }

        function setPaymentStatus(status) {
            paymentStatus = status;

            // Gracefully handle cases where payment status buttons are not present in the DOM
            const paidBtn = document.getElementById('paidBtn');
            const pendingBtn = document.getElementById('pendingBtn');

            if (paidBtn) {
                paidBtn.classList.toggle('active', status === 'paid');
            }

            if (pendingBtn) {
                pendingBtn.classList.toggle('active', status === 'pending');
            }
        }

        window.saveBill = function() {
            console.log('saveBill function called');
            // Validate inputs
            const customerName = document.getElementById('customerName').value;
            const mobileNumber = document.getElementById('mobileNumber').value;
            
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            if (!mobileNumber || !/^\d{10}$/.test(mobileNumber)) {
                showNotification('Please enter a valid 10-digit mobile number', 'error');
                return;
            }
            
            if (items.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }

            // Create bill data object
            const billData = {
                id: isEditMode ? currentBillId : Date.now().toString(),
                billNumber: document.getElementById('billNumber').value,
                billDate: document.getElementById('billDate').value,
                customerName: customerName,
                mobileNumber: mobileNumber,
                tableNumber: document.getElementById('tableNumber').value,
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent.slice(1)),
                cgstRate: parseFloat(document.getElementById('cgstRate').value),
                sgstRate: parseFloat(document.getElementById('sgstRate').value),
                cgstAmount: parseFloat(document.getElementById('cgstAmount').textContent.slice(1)),
                sgstAmount: parseFloat(document.getElementById('sgstAmount').textContent.slice(1)),
                finalTotal: parseFloat(document.getElementById('finalTotal').textContent.slice(1)),
                paymentStatus: paymentStatus,
                paymentMethod: document.getElementById('paymentMethod').value,
                createdAt: isEditMode ? new Date().toISOString() : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Save to localStorage
            try {
                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                console.log('Current bills in storage:', bills);
                
                if (isEditMode) {
                    // Find and update existing bill
                    const index = bills.findIndex(bill => bill.id === currentBillId);
                    if (index !== -1) {
                        bills[index] = billData;
                        console.log('Updated existing bill at index', index);
                    }
                } else {
                    // Add new bill
                    bills.push(billData);
                    console.log('Added new bill:', billData);
                }
                
                localStorage.setItem('bills', JSON.stringify(bills));
                console.log('Bills after save:', JSON.parse(localStorage.getItem('bills') || '[]'));
                
            } catch (error) {
                console.error('Error saving bill to localStorage:', error);
                showNotification('Error saving bill: ' + error.message, 'error');
                return;
            }

            // Save bill to file system (simulated) without downloading, wrapped in try/catch for robustness
            try {
                saveBillToFileSystem(billData, false);
            } catch (error) {
                console.error('Error while generating/saving bill PDF:', error);
                showNotification('Bill saved, but PDF generation failed. Please try again.', 'warning');
            }
            
            // Show success message
            showNotification(`Bill ${isEditMode ? 'updated' : 'saved'} successfully and stored in order history!`, 'success');
            
            // Reload bill history
            loadBillHistory();
            
            // Reset form for new bill
            if (!isEditMode) {
                initializeNewBill();
            }
        }

        function saveBillToFileSystem(billData, downloadPdf = true) {
            // Create a PDF and save it to local storage with customer name, contact, and date
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Format date for filename
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Create filename with bill number, customer mobile, and date
            const filename = `BILL_${billData.billNumber}_${billData.mobileNumber}_${dateStr}.pdf`;
            
            // Add content to PDF
            doc.setFontSize(20);
            doc.text('BILL RECEIPT', 105, 20, { align: 'center' });
            
            // Add horizontal line
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);
            
            doc.setFontSize(12);
            doc.text(`Bill No: ${billData.billNumber}`, 20, 35);
            doc.text(`Date: ${billData.billDate}`, 20, 45);
            
            doc.text(`Customer: ${billData.customerName}`, 20, 60);
            doc.text(`Mobile: +91-${billData.mobileNumber}`, 20, 70);
            doc.text(`Table No: ${billData.tableNumber || 'N/A'}`, 20, 80);
            
            // Add items header
            doc.setFontSize(14);
            doc.text('Items:', 20, 95);
            doc.setFontSize(12);
            
            // Add items
            let y = 105;
            billData.items.forEach((item, index) => {
                doc.text(`${index + 1}. ${item.itemName} × ${item.quantity} = ₹${item.subtotal.toFixed(2)}`, 30, y);
                y += 10;
            });

            // Add totals
            y += 10;
            doc.text(`Subtotal: ₹${billData.subtotal.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`CGST (${billData.cgstRate}%): ₹${billData.cgstAmount.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`SGST (${billData.sgstRate}%): ₹${billData.sgstAmount.toFixed(2)}`, 20, y);
            y += 10;
            
            // Final total with bold styling
            doc.setFont(undefined, 'bold');
            // Fix the final amount display by ensuring it's a proper number
            const finalTotalValue = typeof billData.finalTotal === 'number' ? billData.finalTotal : parseFloat(billData.finalTotal || 0);
            doc.text(`Final Total: ₹${finalTotalValue.toFixed(2)}`, 20, y);
            doc.setFont(undefined, 'normal');
            
            // Payment status
            y += 10;
            doc.text(`Status: ${billData.paymentStatus === 'paid' ? '✅ Paid' : '⏳ Pending'}`, 20, y);
            
            // Payment method
            y += 10;
            doc.text(`Payment Method: ${billData.paymentMethod}`, 20, y);
            
            // Footer
            y += 20;
            doc.setFontSize(10);
            doc.text('Thanks for your order!', 105, y, { align: 'center' });
            
            // Add horizontal line
            y += 5;
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            
            // Save PDF to local storage
            const pdfData = doc.output('datauristring');
            
            // Create a bills storage object if it doesn't exist
            let billsStorage = JSON.parse(localStorage.getItem('billsPDFStorage') || '{}');
            
            // Create a folder structure in the storage object
            if (!billsStorage.folders) {
                billsStorage.folders = {
                    'bills': {},
                    'history': {}
                };
                localStorage.setItem('billsPDFStorage', JSON.stringify(billsStorage));
            }
            
            // Ensure required folders exist
            if (!billsStorage.folders.bills) {
                billsStorage.folders.bills = {};
            }
            if (!billsStorage.folders.history) {
                billsStorage.folders.history = {};
            }
            
            // Create filename with bill ID
            const filenameWithId = `BILL_${billData.billNumber}_${billData.mobileNumber}_${dateStr}_${billData.id}.pdf`;
            
            // Save the PDF data in the bills folder
            billsStorage.folders.bills[filenameWithId] = pdfData;
            
            // Also save in history folder with date prefix
            const historyFilename = `${dateStr}_BILL_${billData.billNumber}_${billData.mobileNumber}_${billData.id}.pdf`;
            billsStorage.folders.history[historyFilename] = pdfData;
            
            // Update localStorage
            localStorage.setItem('billsPDFStorage', JSON.stringify(billsStorage));
            
            // Only download the PDF and show instructions if downloadPdf is true
            if (downloadPdf) {
                // Download the PDF to the specified folder
                // The user will need to navigate to C:\Users\bodkh\OneDrive\Desktop\Ailexity Project\Bill history
                // when the save dialog appears
                doc.save(filename);
                
                // Show a notification with instructions
                showNotification(`Please save the PDF to C:\Users\bodkh\OneDrive\Desktop\Ailexity Project\Bill history folder`, 'info', 8000);
                
                // Show a modal with detailed instructions
                showSaveInstructionsModal(filename);
            }
            
            console.log(`PDF saved as ${filename} in bill management storage folder`);
            console.log(`Also saved as ${historyFilename} in history folder`);
            console.log(`Please save the PDF to C:\Users\bodkh\OneDrive\Desktop\Ailexity Project\Bill history folder`);
        }

        function generatePDF(billData, returnBlob = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add content to PDF
            doc.setFontSize(20);
            doc.text('BILL RECEIPT', 105, 20, { align: 'center' });
            
            // Add horizontal line
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);
            
            doc.setFontSize(12);
            doc.text(`Bill No: ${billData.billNumber}`, 20, 35);
            doc.text(`Date: ${billData.billDate}`, 20, 45);
            
            doc.text(`Customer: ${billData.customerName}`, 20, 60);
            doc.text(`Mobile: +91-${billData.mobileNumber}`, 20, 70);
            
            // Add items header
            doc.setFontSize(14);
            doc.text('Items:', 20, 85);
            doc.setFontSize(12);
            
            // Add items
            let y = 95;
            billData.items.forEach((item, index) => {
                doc.text(`${index + 1}. ${item.itemName} × ${item.quantity} = ₹${item.subtotal.toFixed(2)}`, 30, y);
                y += 10;
            });

            // Add totals
            y += 10;
            doc.text(`Subtotal: ₹${billData.subtotal.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`CGST (${billData.cgstRate}%): ₹${billData.cgstAmount.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`SGST (${billData.sgstRate}%): ₹${billData.sgstAmount.toFixed(2)}`, 20, y);
            y += 10;
            
            // Final total with bold styling
            doc.setFont(undefined, 'bold');
            // Fix the final amount display by ensuring it's a proper number
            const finalTotalValue = typeof billData.finalTotal === 'number' ? billData.finalTotal : parseFloat(billData.finalTotal || 0);
            doc.text(`Final Total: ₹${finalTotalValue.toFixed(2)}`, 20, y);
            doc.setFont(undefined, 'normal');
            
            // Payment status
            y += 10;
            doc.text(`Status: ${billData.paymentStatus === 'paid' ? '✅ Paid' : '⏳ Pending'}`, 20, y);
            
            // Payment method
            y += 10;
            doc.text(`Payment Method: ${billData.paymentMethod}`, 20, y);
            
            // Footer
            y += 20;
            doc.setFontSize(10);
            doc.text('Thanks for your order!', 105, y, { align: 'center' });
            
            // Add horizontal line
            y += 5;
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            
            const fileName = `${billData.customerName.replace(/\s+/g, '')}_${billData.billNumber}.pdf`;
            if (returnBlob) {
                // Return blob instead of saving
                return doc.output('blob');
            } else {
                doc.save(fileName);
                return fileName;
            }
        }

        function printBill() {
            if (items.length === 0) {
                showNotification('Please add items to the bill before printing', 'error');
                return;
            }
            
            // Create a temporary bill data object for printing
            const billData = {
                billNumber: document.getElementById('billNumber').value,
                billDate: new Date().toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }),
                customerName: document.getElementById('customerName').value || 'Customer',
                mobileNumber: document.getElementById('mobileNumber').value || '',
                tableNumber: document.getElementById('tableNumber').value || '',
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent.slice(1)),
                cgstRate: parseFloat(document.getElementById('cgstRate').value),
                sgstRate: parseFloat(document.getElementById('sgstRate').value),
                cgstAmount: parseFloat(document.getElementById('cgstAmount').textContent.slice(1)),
                sgstAmount: parseFloat(document.getElementById('sgstAmount').textContent.slice(1)),
                finalTotal: parseFloat(document.getElementById('finalTotal').textContent.slice(1)),
                paymentStatus: paymentStatus,
                paymentMethod: document.getElementById('paymentMethod').value,
                restaurantName: document.querySelector('.restaurant-name')?.textContent || 'Restaurant'
            };
            
            // Initialize PDF with modern settings
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set default font
            doc.setFont('helvetica');
            
            // Page dimensions
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            
            // Add title
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('BILL RECEIPT', pageWidth / 2, 25, { align: 'center' });
            
            // Add title underline
            doc.setLineWidth(0.5);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, 30, pageWidth - margin, 30);
            
            // Add customer details
            let y = 45;
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setDrawColor(100, 100, 100);
            
            // Bill info in two columns
            doc.text(`Bill No: ${billData.billNumber}`, margin, y);
            doc.text(`Date: ${billData.billDate}`, pageWidth - margin, y, { align: 'right' });
            y += 7;
            
            doc.text(`Customer: ${billData.customerName}`, margin, y);
            if (billData.mobileNumber) {
                doc.text(`Mobile: +91-${billData.mobileNumber}`, margin, y + 7);
            }
            doc.text(`Table No: ${billData.tableNumber || 'N/A'}`, margin, y + 14);
            
            // Add items table header
            y += 35;
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y - 5, contentWidth, 10, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Item', margin + 2, y);
            doc.text('Qty', margin + 100, y, { align: 'right' });
            doc.text('Rate (₹)', margin + 130, y, { align: 'right' });
            doc.text('Amount (₹)', margin + contentWidth - 2, y, { align: 'right' });
            
            // Add items
            doc.setFont(undefined, 'normal');
            y += 7;
            billData.items.forEach(item => {
                // Format numbers with proper decimal places
                const rate = (item.subtotal / item.quantity).toFixed(2);
                const amount = item.subtotal.toFixed(2);
                
                doc.text(item.itemName, margin + 2, y);
                doc.text(item.quantity.toString(), margin + 100, y, { align: 'right' });
                doc.text(rate, margin + 130, y, { align: 'right' });
                doc.text(amount, margin + contentWidth - 2, y, { align: 'right' });
                y += 7;
            });
            
            // Add totals section
            y += 10;
            doc.setLineWidth(0.2);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;
            
            // Subtotal
            doc.text('Subtotal:', margin + 100, y, { align: 'right' });
            doc.text(billData.subtotal.toFixed(2), margin + contentWidth - 2, y, { align: 'right' });
            y += 7;
            
            // CGST
            doc.text(`CGST (${billData.cgstRate}%):`, margin + 100, y, { align: 'right' });
            doc.text(billData.cgstAmount.toFixed(2), margin + contentWidth - 2, y, { align: 'right' });
            y += 7;
            
            // SGST
            doc.text(`SGST (${billData.sgstRate}%):`, margin + 100, y, { align: 'right' });
            doc.text(billData.sgstAmount.toFixed(2), margin + contentWidth - 2, y, { align: 'right' });
            y += 10;
            
            // Total line
            doc.setLineWidth(0.5);
            doc.setDrawColor(150, 150, 150);
            doc.line(margin + 100, y, pageWidth - margin, y);
            y += 3;
            
            // Final Total
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Final Total:', margin + 100, y, { align: 'right' });
            // Fix the final amount display by ensuring it's a proper number
            const finalTotalValue = typeof billData.finalTotal === 'number' ? billData.finalTotal : parseFloat(billData.finalTotal || 0);
            // Format the final total properly
            const finalTotal = `₹${finalTotalValue.toFixed(2)}`;
            doc.text(finalTotal, margin + contentWidth - 2, y, { align: 'right' });
            
            // Payment status
            y += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(billData.paymentStatus === 'paid' ? 0 : 200, billData.paymentStatus === 'paid' ? 150 : 0, 0);
            doc.text(`STATUS: ${billData.paymentStatus.toUpperCase()}`, margin, y);
            doc.setTextColor(0, 0, 0);
            
            // Footer
            y = doc.internal.pageSize.getHeight() - 20;
            doc.setLineWidth(0.2);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text('Thank you for dining with us!', pageWidth / 2, y, { align: 'center' });
            
            // Add border around the page
            doc.setDrawColor(220, 220, 220);
            doc.rect(5, 5, pageWidth - 10, doc.internal.pageSize.getHeight() - 10);
            
            // Auto-print and open in new window
            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
        }

        async function sendWhatsApp() {
            const mobileNumber = document.getElementById('mobileNumber').value;
            if (!mobileNumber || !/^\d{10}$/.test(mobileNumber)) {
                showNotification('Please enter a valid 10-digit mobile number', 'error');
                return;
            }

            if (items.length === 0) {
                showNotification('Please add items to the bill before sending', 'error');
                return;
            }

            try {
                // Show loading state
                const sendBtn = document.querySelector('button[onclick="sendWhatsApp()"]');
                const originalBtnText = sendBtn.innerHTML;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Receipt...';

                // Build bill data from current form (without saving)
                const billData = {
                    billNumber: document.getElementById('billNumber').value,
                    billDate: document.getElementById('billDate').value,
                    customerName: document.getElementById('customerName').value || 'Customer',
                    mobileNumber: mobileNumber,
                    items: items,
                    subtotal: parseFloat(document.getElementById('subtotal').textContent.slice(1)),
                    cgstRate: parseFloat(document.getElementById('cgstRate').value),
                    sgstRate: parseFloat(document.getElementById('sgstRate').value),
                    cgstAmount: parseFloat(document.getElementById('cgstAmount').textContent.slice(1)),
                    sgstAmount: parseFloat(document.getElementById('sgstAmount').textContent.slice(1)),
                    finalTotal: parseFloat(document.getElementById('finalTotal').textContent.slice(1)),
                    paymentStatus: paymentStatus,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    tableNumber: document.getElementById('tableNumber').value || ''
                };

                // Generate the PDF blob
                const pdfBlob = await generatePDF(billData, true);
                
                // Format date and time
                const now = new Date();
                const formattedDate = now.toLocaleDateString('en-GB');
                const formattedTime = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });

                // Create message content using the requested template
                const restaurantName = document.getElementById('restaurantName')?.value || 'our restaurant';
                const customerName = billData.customerName || 'Valued Customer';
                const amount = billData.finalTotal.toFixed(2);
                const paymentMode = billData.paymentMethod.charAt(0).toUpperCase() + billData.paymentMethod.slice(1);
                const dateTime = `${formattedDate} at ${formattedTime}`;

                const message = `Hi ${customerName}, thank you for dining with us at ${restaurantName}! 😊
We appreciate your visit and hope you had a wonderful experience.

📎 Please find your bill attached below.

🧾 Total Amount Paid: ₹${amount}
💳 Payment Mode: ${paymentMode}
📅 Date & Time: ${dateTime}

If you have any feedback, feel free to reply—we'd love to hear from you!
Looking forward to serving you again soon. 🍽

Powered by Ailexity Tech Pvt Ltd
– Team ${restaurantName}`;

                // Update PDF filename to match the requested format
                const pdfFilename = `Invoice_${(billData.customerName || 'Customer').replace(/\s+/g, '_')}_${formattedDate.replace(/\//g, '-')}.pdf`;

                // Create a download link for the PDF
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Encode the message for URL
                const encodedMessage = encodeURIComponent(message);
                
                // Create WhatsApp Web URL with the message
                const whatsappUrl = `https://wa.me/91${mobileNumber}?text=${encodedMessage}`;
                
                // Open WhatsApp Web in a new tab
                const newWindow = window.open(whatsappUrl, '_blank');
                
                // Show success message
                showNotification('Opening WhatsApp with your receipt. Please send the PDF manually.', 'info');
                
                // After a short delay, open the PDF download
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = pdfUrl;
                    a.download = pdfFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(pdfUrl);
                }, 1000);
                
            } catch (error) {
                console.error('Error sending WhatsApp message:', error);
                
                // Fallback to direct WhatsApp Web method
                const whatsappUrl = `https://wa.me/91${mobileNumber}?text=${encodeURIComponent('Here is your receipt. Please check your messages.')}`;
                window.open(whatsappUrl, '_blank');
                
                showNotification(
                    'Could not send receipt automatically. ' +
                    'Please download and send the receipt manually.', 
                    'error', 
                    10000
                );
            } finally {
                // Reset button state
                const sendBtn = document.querySelector('button[onclick="sendWhatsApp()"]');
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalBtnText || 'Send via WhatsApp';
                }
            }
        }
        
        function closeWhatsAppGuide() {
            const modal = document.getElementById('whatsappGuideModal');
            if (modal) {
                modal.style.display = 'none';
                modal.remove();
            }
        }

        function clearBill() {
            if (items.length === 0) {
                initializeNewBill();
                return;
            }
            
            if (confirm('Are you sure you want to clear this bill?')) {
                initializeNewBill();
            }
        }

        function loadBillHistory() {
            try {
                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                console.log('Loaded bills from storage:', bills);
                renderBillHistory(bills);
            } catch (error) {
                console.error('Error loading bill history:', error);
                showNotification('Error loading bill history', 'error');
            }
        }

        // Toggle select all bills
        function toggleSelectAllBills(checkbox) {
            const checkboxes = document.querySelectorAll('.bill-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        }

        // Update bulk action buttons based on selection
        function updateBulkActions() {
            const selectedCount = document.querySelectorAll('.bill-checkbox:checked').length;
            const bulkActions = document.getElementById('bulkActions');
            if (selectedCount > 0) {
                bulkActions.style.display = 'flex';
            } else {
                bulkActions.style.display = 'none';
            }
        }

        // Delete selected bills
        function deleteSelectedBills() {
            const selectedBills = Array.from(document.querySelectorAll('.bill-checkbox:checked'))
                .map(checkbox => checkbox.value);
                
            if (selectedBills.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${selectedBills.length} selected bill(s)?`)) {
                let bills = JSON.parse(localStorage.getItem('bills') || '[]');
                bills = bills.filter(bill => !selectedBills.includes(bill.id));
                localStorage.setItem('bills', JSON.stringify(bills));
                loadBillHistory();
                document.getElementById('selectAllBills').checked = false;
                updateBulkActions();
            }
        }

        // Print selected bills
        function printSelectedBills() {
            const selectedBills = Array.from(document.querySelectorAll('.bill-checkbox:checked'))
                .map(checkbox => checkbox.value);
                
            if (selectedBills.length === 0) return;
            
            // Print each selected bill
            selectedBills.forEach((billId, index) => {
                // Small delay between prints
                setTimeout(() => printBillFromModal(billId), index * 1000);
            });
        }

        function renderBillHistory(bills) {
            const tbody = document.getElementById('billHistory');
            tbody.innerHTML = '';

            // Sort bills by date (newest first). Fallback to createdAt if updatedAt is missing.
            bills.sort((a, b) => {
                const dateB = new Date(b.updatedAt || b.createdAt || 0);
                const dateA = new Date(a.updatedAt || a.createdAt || 0);
                return dateB - dateA;
            });

            bills.forEach(bill => {
                const row = tbody.insertRow();
                
                // Format date
                const billDate = new Date(bill.updatedAt || bill.billDate);
                const formattedDate = billDate.toLocaleDateString() + ' ' + billDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Count items
                const itemCount = bill.items ? bill.items.length : 0;
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" class="bill-checkbox" value="${bill.id}" onchange="updateBulkActions()">
                    </td>
                    <td>${bill.billNumber}</td>
                    <td>${formattedDate}</td>
                    <td>${bill.customerName}</td>
                    <td>${bill.mobileNumber}</td>
                    <td>${bill.tableNumber || 'N/A'}</td>
                    <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
                    <td>₹${bill.finalTotal.toFixed(2)}</td>
                    <td><span class="status-badge status-${bill.paymentStatus || 'paid'}">${bill.paymentStatus === 'pending' ? '⏳ Pending' : '✅ Paid'}</span></td>
                    <td>
                        <div class="bill-actions">
                            <button class="bill-action-btn view-btn" onclick="viewBill('${bill.id}')">View</button>
                            <button class="bill-action-btn edit-btn" onclick="editBill('${bill.id}')">Edit</button>
                            <button class="bill-action-btn download-btn" onclick="downloadBillPDF('${bill.id}')">Download</button>
                            <button class="bill-action-btn delete-btn" onclick="deleteBill('${bill.id}')">Delete</button>
                        </div>
                    </td>
                `;
            });
        }

        function filterBillHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            
            const filteredBills = bills.filter(bill => {
                // Search term filter
                const matchesSearch = 
                    bill.customerName.toLowerCase().includes(searchTerm) ||
                    bill.mobileNumber.includes(searchTerm) ||
                    bill.billNumber.toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || bill.paymentStatus === statusFilter;
                
                // Date range filter
                let matchesDateRange = true;
                if (startDate && endDate) {
                    const billDate = new Date(bill.updatedAt || bill.billDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59); // Set to end of day
                    
                    matchesDateRange = billDate >= start && billDate <= end;
                }
                
                return matchesSearch && matchesStatus && matchesDateRange;
            });
            
            renderBillHistory(filteredBills);
        }

        function viewBill(billId) {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            const bill = bills.find(b => b.id === billId);
            
            if (!bill) {
                showNotification('Bill not found', 'error');
                return;
            }
            
            // Format date
            const billDate = new Date(bill.billDate);
            const formattedDate = billDate.toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            // Set modal title
            document.getElementById('modalTitle').textContent = `Bill #${bill.billNumber}`;
            
            // Generate modal content with proper styling
            let modalContent = `
                <div class="bill-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em; margin-bottom: 5px;">Customer</div>
                            <div style="color: #000;">${bill.customerName || 'Walk-in Customer'}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em; margin-bottom: 5px;">Mobile</div>
                            <div style="color: #000;">${bill.mobileNumber || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em; margin-bottom: 5px;">Table No</div>
                            <div style="color: #000;">${bill.tableNumber || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em; margin-bottom: 5px;">Date & Time</div>
                            <div style="color: #000;">${formattedDate}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #e0e0e0; margin-top: 10px;">
                        <div>
                            <span style="font-weight: 600; color: #2c3e50; font-size: 0.95em; margin-right: 10px;">Status:</span>
                            <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; background-color: ${bill.paymentStatus === 'pending' ? '#fff3cd' : '#d4edda'}; color: ${bill.paymentStatus === 'pending' ? '#856404' : '#155724'};">
                                ${bill.paymentStatus === 'pending' ? '⏳ Pending' : '✅ Paid'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="bill-section">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 1.3em; font-weight: 600; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">Order Items</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item Name</th>
                                    <th style="text-align: right; min-width: 80px;">Qty</th>
                                    <th style="text-align: right; min-width: 100px;">Rate (₹)</th>
                                    <th style="text-align: right; min-width: 120px;">Amount (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Add items to the table
            bill.items.forEach(item => {
                modalContent += `
                    <tr>
                        <td style="color: #000;">${item.itemName}</td>
                        <td style="text-align: right; color: #000;">${item.quantity}</td>
                        <td style="text-align: right; color: #000;">${parseFloat(item.pricePerUnit).toFixed(2)}</td>
                        <td style="text-align: right; color: #000; font-weight: 500;">${parseFloat(item.subtotal).toFixed(2)}</td>
                    </tr>`;
            });
            
            // Add totals section
            modalContent += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="totals-section">
                    <div>
                        <span>Subtotal:</span>
                        <span>₹${parseFloat(bill.subtotal || 0).toFixed(2)}</span>
                    </div>
                    <div>
                        <span>CGST (${bill.cgstRate || 0}%):</span>
                        <span>₹${parseFloat(bill.cgstAmount || 0).toFixed(2)}</span>
                    </div>
                    <div>
                        <span>SGST (${bill.sgstRate || 0}%):</span>
                        <span>₹${parseFloat(bill.sgstAmount || 0).toFixed(2)}</span>
                    </div>
                    <div style="color: #2c3e50 !important;">
                        <span>GRAND TOTAL:</span>
                        <span>₹${parseFloat(bill.finalTotal || 0).toFixed(2)}</span>
                    </div>
                </div>
                
                <div style="margin: 30px 0 20px; padding: 20px; background: #f5f5f5; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                    <p style="margin: 0 0 10px 0; font-size: 1.1em; color: #2c3e50; font-weight: 500;">Thank you for dining with us!</p>
                    <p style="margin: 0; color: #555; font-size: 0.95em;">For any queries, please contact: <strong>+91 XXXXXXXXXX</strong></p>
                </div>
                
                <div class="modal-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef; display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                    <button 
                        onclick="printBillFromModal('${billId}')" 
                        style="
                            padding: 12px 24px;
                            background: #4a6cf7;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 500;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#3a5bd9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#4a6cf7'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';
                        onmousedown="this.style.transform='translateY(0)';"
                        ontouchstart="this.style.transform='translateY(0)';">
                        <i class="fas fa-print" style="font-size: 15px;"></i>
                        Print Bill
                    </button>
                    <button 
                        onclick="sendWhatsAppFromModal('${billId}')" 
                        style="
                            padding: 12px 24px;
                            background: #25D366;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-weight: 500;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#128C7E'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#25D366'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';
                        onmousedown="this.style.transform='translateY(0)';"
                        ontouchstart="this.style.transform='translateY(0)';">
                        <i class="fab fa-whatsapp" style="font-size: 17px;"></i>
                        WhatsApp
                    </button>
                    <button 
                        onclick="editBill('${billId}')" 
                        style="
                            padding: 12px 24px;
                            background: #ffc107;
                            color: #000;
                            border: none;
                            border-radius: 6px;
                            font-weight: 500;
                            font-size: 0.95em;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        "
                        onmouseover="this.style.backgroundColor='#e0a800'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.backgroundColor='#ffc107'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';
                        onmousedown="this.style.transform='translateY(0)';"
                        ontouchstart="this.style.transform='translateY(0)';">
                        <i class="fas fa-edit" style="font-size: 15px;"></i>
                        Edit Bill
                    </button>
                </div>
            `;
            
            // Set modal content
            document.getElementById('modalContent').innerHTML = modalContent;
            
            // Show modal
            openModal();
        }

        function openModal() {
            document.getElementById('billModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeModal() {
            document.getElementById('billModal').style.display = 'none';
            document.body.style.overflow = ''; // Re-enable background scrolling
        }
        
        // Close modal when clicking outside the content
        window.onclick = function(event) {
            const modal = document.getElementById('billModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function editBill(billId) {
            console.log('=== editBill() called ===');
            console.log('Editing bill with ID:', billId);
            
            try {
                // Get bills from localStorage
                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                console.log(`Found ${bills.length} bills in storage`);
                
                if (bills.length === 0) {
                    console.error('❌ No bills found in storage');
                    showNotification('No bills found in storage', 'error');
                    return;
                }
                
                // Find the bill to edit
                const bill = bills.find(b => b.id === billId);
                
                if (!bill) {
                    console.error(`❌ Bill not found with ID: ${billId}`);
                    console.log('Available bill IDs:', bills.map(b => b.id));
                    showNotification('Bill not found', 'error');
                    return;
                }
                
                console.log('✅ Found bill to edit:', bill);
                
                // Close any open modal
                closeModal();
                
                // Scroll to top to show the form
                window.scrollTo(0, 0);
                
                // Update form fields with bill data
                const fieldsToUpdate = {
                    'customerName': bill.customerName || '',
                    'mobileNumber': bill.mobileNumber || '',
                    'billNumber': bill.billNumber || '',
                    'billDate': bill.billDate || new Date().toISOString().slice(0, 16),
                    'billType': bill.billType || 'dine-in',
                    'tableNumber': bill.tableNumber || '1',
                    'paymentMethod': bill.paymentMethod || 'CASH',
                    'sgstRate': bill.sgstRate || '9',
                    'cgstRate': bill.cgstRate || '9'
                };
                
                // Update each field and log the update
                Object.entries(fieldsToUpdate).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                        console.log(`Set ${id} to:`, value);
                    } else {
                        console.error(`❌ Could not find element with ID: ${id}`);
                    }
                });
                
                // Process and set items
                console.log('Original bill items:', bill.items);
                
                // Ensure items is an array and has valid data
                let itemsToSet = [];
                if (Array.isArray(bill.items)) {
                    itemsToSet = bill.items.map(item => ({
                        itemName: item.itemName || 'Unnamed Item',
                        quantity: parseInt(item.quantity) || 0,
                        pricePerUnit: parseFloat(item.pricePerUnit) || 0,
                        subtotal: parseFloat(item.subtotal) || (parseInt(item.quantity) || 0) * (parseFloat(item.pricePerUnit) || 0)
                    }));
                } else if (bill.items && typeof bill.items === 'object') {
                    // Handle case where items is an object instead of an array
                    console.warn('⚠️ Items is an object, converting to array');
                    itemsToSet = Object.values(bill.items).map(item => ({
                        itemName: item.itemName || 'Unnamed Item',
                        quantity: parseInt(item.quantity) || 0,
                        pricePerUnit: parseFloat(item.pricePerUnit) || 0,
                        subtotal: parseFloat(item.subtotal) || (parseInt(item.quantity) || 0) * (parseFloat(item.pricePerUnit) || 0)
                    }));
                }
                
                console.log('Processed items to set:', itemsToSet);
                
                // Update the global items array
                items = [...itemsToSet];
                console.log('Global items array updated. Length:', items.length);
                
                // Update the UI
                updateItemsList();
                calculateTotal();
                
                // Set payment status
                setPaymentStatus(bill.paymentStatus || 'paid');
                
                // Set edit mode
                isEditMode = true;
                currentBillId = billId;
                
                // Force UI updates
                document.getElementById('totalItems').textContent = items.length;
                
                // Additional debug after a short delay
                setTimeout(() => {
                    console.log('=== UI Update Verification ===');
                    const itemsInDOM = document.querySelectorAll('#itemsList tr').length;
                    console.log(`Items in DOM: ${itemsInDOM}, Expected: ${items.length}`);
                    
                    if (itemsInDOM !== items.length) {
                        console.warn('⚠️ Mismatch between items array and DOM elements');
                        console.log('Items array:', items);
                        console.log('Table HTML:', document.getElementById('itemsList').innerHTML);
                    }
                    
                    // Check if the form is visible
                    const form = document.querySelector('.billing-form');
                    if (form) {
                        console.log('Form is in the document');
                        console.log('Form visibility:', window.getComputedStyle(form).display);
                    } else {
                        console.error('❌ Billing form not found in the document');
                    }
                }, 300);
                
                console.log('✅ Edit mode activated for bill ID:', billId);
            } catch (error) {
                console.error('❌ Error in editBill:', error);
                showNotification('Error loading bill for editing', 'error');
            }
        }

        function deleteBill(billId) {
            if (confirm('Are you sure you want to delete this bill? This action cannot be undone.')) {
                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                const updatedBills = bills.filter(bill => bill.id !== billId);
                localStorage.setItem('bills', JSON.stringify(updatedBills));
                
                showNotification('Bill deleted successfully', 'success');
                loadBillHistory();
            }
        }
        
        function downloadBillPDF(billId) {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            const bill = bills.find(b => b.id === billId);
            
            if (!bill) {
                showNotification('Bill not found', 'error');
                return;
            }
            
            // Generate and download PDF
            saveBillToFileSystem(bill, true);
        }

        function printBillFromModal(billId) {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            const bill = bills.find(b => b.id === billId);
            
            if (!bill) {
                showNotification('Bill not found', 'error');
                return;
            }
            
            // Generate PDF and trigger print dialog
            const { jsPDF } = window.jspdf;
            
            // Create a temporary div to hold the content
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            document.body.appendChild(tempDiv);
            
            // Create a new PDF with all watermarks disabled
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true,
                compress: true,
                // Disable any default watermarks
                watermark: { text: '' },
                // Force a clean document
                hotfixes: ["px_scaling"]
            });
            
            // Ensure we're starting with a clean slate
            while (doc.internal.getNumberOfPages() > 1) {
                doc.deletePage(2);
            }
            
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 20;
            
            // Set default font
            doc.setFont('helvetica');
            
            // Add header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('RESTAURANT BILL', pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            // Add horizontal line
            doc.setLineWidth(0.5);
            doc.line(20, y, pageWidth - 20, y);
            y += 15;
            
            // Bill info section
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            
            // Bill number and date with proper spacing
            const billInfoY = y;
            
            // Draw bill number and date in a single line with proper spacing
            const billNoText = `Bill No: ${bill.billNumber}`;
            const dateText = `Date: ${bill.billDate}`;
            
            // Calculate positions
            const billNoWidth = doc.getTextWidth(billNoText);
            const dateWidth = doc.getTextWidth(dateText);
            const totalWidth = billNoWidth + dateWidth + 20; // 20mm padding between
            
            // Draw bill number
            doc.text(billNoText, 20, y);
            
            // Draw date aligned to right with proper spacing
            doc.text(dateText, pageWidth - 20 - dateWidth, y);
            
            // Add a subtle separator line
            doc.setLineWidth(0.2);
            doc.setDrawColor(220, 220, 220);
            doc.line(20, y + 3, pageWidth - 20, y + 3);
            y += 8;
            
            // Add time
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            doc.text(`Time: ${timeStr}`, 20, y);
            y += 15;
            
            // Customer info
            doc.setFont(undefined, 'bold');
            doc.text('Customer Details:', 20, y);
            y += 8;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${bill.customerName || 'Walk-in Customer'}`, 25, y);
            y += 8;
            
            if (bill.mobileNumber) {
                doc.text(`Mobile: +91-${bill.mobileNumber}`, 25, y);
                y += 8;
            }
            
            if (bill.tableNumber) {
                doc.text(`Table No: ${bill.tableNumber}`, 25, y);
                y += 8;
            }
            
            // Add space before items
            y += 5;
            
            // Items header
            doc.setFont(undefined, 'bold');
            doc.text('ITEMS', 20, y);
            doc.text('QTY', 120, y);
            doc.text('PRICE', 160, y);
            doc.text('TOTAL', pageWidth - 20, y, { align: 'right' });
            y += 8;
            
            // Horizontal line under header
            doc.setLineWidth(0.2);
            doc.line(20, y, pageWidth - 20, y);
            y += 8;
            
            // Add items
            doc.setFont(undefined, 'normal');
            bill.items.forEach(item => {
                // Check if we need a new page
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                // Item name (with wrapping)
                const itemName = item.itemName;
                const splitName = doc.splitTextToSize(itemName, 70);
                
                // Calculate height needed for this item
                const itemHeight = Math.max(10, splitName.length * 7);
                
                // Draw item name with wrapping
                doc.text(splitName, 25, y + 3);
                
                // Draw quantity and price on the right
                doc.text(`${item.quantity}`, 120, y + 3);
                doc.text(`₹${item.price.toFixed(2)}`, 160, y + 3);
                doc.text(`₹${item.subtotal.toFixed(2)}`, pageWidth - 20, y + 3, { align: 'right' });
                
                y += itemHeight;
            });
            
            // Add space before totals
            y += 10;
            
            // Add totals
            doc.setLineWidth(0.2);
            doc.line(120, y, pageWidth - 20, y);
            y += 10;
            
            doc.text('Subtotal:', 120, y, { align: 'right' });
            doc.text(`₹${bill.subtotal.toFixed(2)}`, pageWidth - 20, y, { align: 'right' });
            y += 8;
            
            if (bill.cgstRate > 0) {
                doc.text(`CGST (${bill.cgstRate}%):`, 120, y, { align: 'right' });
                doc.text(`₹${bill.cgstAmount.toFixed(2)}`, pageWidth - 20, y, { align: 'right' });
                y += 8;
            }
            
            if (bill.sgstRate > 0) {
                doc.text(`SGST (${bill.sgstRate}%):`, 120, y, { align: 'right' });
                doc.text(`₹${bill.sgstAmount.toFixed(2)}`, pageWidth - 20, y, { align: 'right' });
                y += 8;
            }
            
            doc.setLineWidth(0.5);
            doc.line(120, y, pageWidth - 20, y);
            y += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL:', 120, y, { align: 'right' });
            // Fix the final amount display by ensuring it's a proper number
            const finalTotalValue = typeof bill.finalTotal === 'number' ? bill.finalTotal : parseFloat(bill.finalTotal || 0);
            doc.text(`₹${finalTotalValue.toFixed(2)}`, pageWidth - 20, y, { align: 'right' });
            doc.setFont(undefined, 'normal');
            y += 15;
            
            // Payment status
            doc.text(`Payment Status: ${bill.paymentStatus === 'paid' ? 'PAID' : 'PENDING'}`, 20, y);
            y += 8;
            
            if (bill.paymentMethod) {
                doc.text(`Payment Method: ${bill.paymentMethod.toUpperCase()}`, 20, y);
                y += 15;
            }
            
            // Footer
            doc.setFontSize(10);
            doc.text('Thank you for your visit!', pageWidth / 2, y + 10, { align: 'center' });
            doc.text('Please come again', pageWidth / 2, y + 16, { align: 'center' });
            
            // Open PDF in new window and trigger print
            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
        }

        async function sendWhatsAppFromModal(billId) {
            try {
                // Show loading state
                const sendBtn = document.querySelector(`button[onclick="sendWhatsAppFromModal('${billId}')"]`);
                const originalBtnText = sendBtn ? sendBtn.innerHTML : '';
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                }

                const bills = JSON.parse(localStorage.getItem('bills') || '[]');
                const bill = bills.find(b => b.id === billId);
                
                if (!bill) {
                    showNotification('Bill not found', 'error');
                    return;
                }
                
                if (!bill.mobileNumber) {
                    showNotification('No mobile number available for this bill', 'error');
                    return;
                }

                // Generate PDF blob for the existing bill
                const pdfBlob = await generatePDF(bill, true);
                
                // Format date and time
                const billDate = new Date(bill.billDate || new Date());
                const formattedDate = billDate.toLocaleDateString('en-GB');
                const formattedTime = billDate.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                // Get restaurant name
                const restaurantName = document.getElementById('restaurantName')?.value || 'our restaurant';
                const customerName = bill.customerName || 'Valued Customer';
                const amount = bill.finalTotal.toFixed(2);
                const paymentMode = (bill.paymentMethod || '').charAt(0).toUpperCase() + (bill.paymentMethod || '').slice(1) || 'N/A';
                const dateTime = `${formattedDate} at ${formattedTime}`;

                // Create message content using the requested template
                const message = `Hi ${customerName}, thank you for dining with us at ${restaurantName}! 😊
We appreciate your visit and hope you had a wonderful experience.

📎 Please find your bill attached below.

🧾 Total Amount Paid: ₹${amount}
💳 Payment Mode: ${paymentMode}
📅 Date & Time: ${dateTime}

If you have any feedback, feel free to reply—we'd love to hear from you!
Looking forward to serving you again soon. 🍽

Powered by Ailexity Tech Pvt Ltd
– Team ${restaurantName}`;

                // Create a download link for the PDF
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const pdfFilename = `Receipt_${bill.billNumber}.pdf`;
                
                // Encode the message for URL
                const encodedMessage = encodeURIComponent(message);
                
                // Create WhatsApp Web URL with the message
                const whatsappUrl = `https://wa.me/91${bill.mobileNumber}?text=${encodedMessage}`;
                
                // Open WhatsApp Web in a new tab
                const newWindow = window.open(whatsappUrl, '_blank');
                
                // Show success message
                showNotification('Opening WhatsApp with your receipt. Please send the PDF manually.', 'info');
                
                // After a short delay, open the PDF download
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = pdfUrl;
                    a.download = pdfFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(pdfUrl);
                }, 1000);
                
            } catch (error) {
                console.error('Error sending WhatsApp message:', error);
                
                // Fallback to direct WhatsApp Web method
                const whatsappUrl = `https://wa.me/91${bill.mobileNumber}?text=${encodeURIComponent('Here is your receipt. Please check your messages.')}`;
                window.open(whatsappUrl, '_blank');
                
                showNotification(
                    'Could not send receipt automatically. ' +
                    'Please download and send the receipt manually.', 
                    'error', 
                    10000
                );
            } finally {
                // Reset button state
                const sendBtn = document.querySelector(`button[onclick="sendWhatsAppFromModal('${billId}')"]`);
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalBtnText || 'Send via WhatsApp';
                }
            }
        }

        function closeModal() {
            document.getElementById('billModal').style.display = 'none';
        }

        function exportToPDF() {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            
            if (bills.length === 0) {
                showNotification('No bills to export', 'error');
                return;
            }
            
            // Sort bills by date (newest first)
            const sortedBills = [...bills].sort((a, b) => 
                new Date(b.updatedAt || b.billDate) - new Date(a.updatedAt || a.billDate)
            );
            
            // Calculate summary
            const totalAmount = sortedBills.reduce((sum, bill) => sum + (parseFloat(bill.finalTotal) || 0), 0);
            const totalBills = sortedBills.length;
            const paidBills = sortedBills.filter(bill => bill.paymentStatus === 'paid').length;
            const pendingBills = totalBills - paidBills;
            
            // Generate PDF
            const { jsPDF } = window.jspdf;
            
            // Create a temporary div to hold the content
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            document.body.appendChild(tempDiv);
            
            // Create a new PDF with all watermarks disabled
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true,
                compress: true,
                // Disable any default watermarks
                watermark: { text: '' },
                // Force a clean document
                hotfixes: ["px_scaling"]
            });
            
            // Ensure we're starting with a clean slate
            while (doc.internal.getNumberOfPages() > 1) {
                doc.deletePage(2);
            }
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let y = margin;
            
            // Set default font
            doc.setFont('helvetica');
            
            // Add header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RESTAURANT BILLING SYSTEM', pageWidth / 2, y, { align: 'center' });
            y += 8;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('ORDER HISTORY REPORT', pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            // Add generated date and time
            const now = new Date();
            const formattedDate = now.toLocaleDateString('en-GB');
            const formattedTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            doc.setFontSize(10);
            doc.text(`Generated: ${formattedDate} at ${formattedTime}`, pageWidth - margin, y, { align: 'right' });
            y += 15;
            
            // Add summary boxes
            const boxWidth = (contentWidth - 15) / 4; // 4 boxes with 5mm gap
            const boxHeight = 25;
            const boxY = y;
            
            // Total Bills box
            doc.setFillColor(78, 115, 223); // Blue
            doc.roundedRect(margin, y, boxWidth, boxHeight, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('TOTAL BILLS', margin + 5, y + 8);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(totalBills.toString(), margin + 5, y + 18);
            
            // Total Amount box
            doc.setFillColor(28, 200, 138); // Green
            doc.roundedRect(margin + boxWidth + 5, y, boxWidth, boxHeight, 3, 3, 'F');
            doc.text('TOTAL AMOUNT', margin + boxWidth + 10, y + 8);
            doc.setFontSize(12);
            doc.text(`₹${totalAmount.toFixed(2)}`, margin + boxWidth + 10, y + 18);
            
            // Paid Bills box
            doc.setFillColor(54, 185, 204); // Teal
            doc.roundedRect(margin + (boxWidth * 2) + 10, y, boxWidth, boxHeight, 3, 3, 'F');
            doc.text('PAID BILLS', margin + (boxWidth * 2) + 15, y + 8);
            doc.setFontSize(14);
            doc.text(paidBills.toString(), margin + (boxWidth * 2) + 15, y + 18);
            
            // Pending Bills box
            doc.setFillColor(231, 74, 59); // Red
            doc.roundedRect(margin + (boxWidth * 3) + 15, y, boxWidth, boxHeight, 3, 3, 'F');
            doc.text('PENDING BILLS', margin + (boxWidth * 3) + 20, y + 8);
            doc.setFontSize(14);
            doc.text(pendingBills.toString(), margin + (boxWidth * 3) + 20, y + 18);
            
            y += boxHeight + 15;
            doc.setTextColor(0, 0, 0);
            
            // Add table headers
            doc.setFillColor(248, 249, 252);
            doc.setDrawColor(222, 226, 230);
            doc.setLineWidth(0.3);
            
            const columnWidths = [25, 30, 40, 35, 30, 20];
            const headers = ['Bill No', 'Date', 'Customer', 'Items', 'Amount (₹)', 'Status'];
            let x = margin;
            
            // Draw header cells
            headers.forEach((header, i) => {
                doc.rect(x, y, columnWidths[i], 10, 'FD');
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(header, x + 3, y + 6);
                x += columnWidths[i];
            });
            
            y += 10;
            
            // Add table rows
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            sortedBills.forEach(bill => {
                // Check if we need a new page
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }
                
                x = margin;
                const rowHeight = 8;
                
                // Bill No
                doc.text(bill.billNumber, x + 3, y + 5);
                x += columnWidths[0];
                
                // Date
                doc.text(bill.billDate, x + 3, y + 5);
                x += columnWidths[1];
                
                // Customer (truncate if too long)
                const customerName = bill.customerName.length > 15 ? 
                    bill.customerName.substring(0, 15) + '...' : bill.customerName;
                doc.text(customerName, x + 3, y + 5);
                x += columnWidths[2];
                
                // Items Count
                doc.text(bill.items.length.toString(), x + 3, y + 5, { align: 'center' });
                x += columnWidths[3];
                
                // Amount
                doc.text(`₹${parseFloat(bill.finalTotal).toFixed(2)}`, x + 3, y + 5, { align: 'right' });
                x += columnWidths[4];
                
                // Status
                const isPaid = bill.paymentStatus === 'paid';
                if (isPaid) {
                    doc.setTextColor(0, 128, 0); // Green for paid
                } else {
                    doc.setTextColor(200, 0, 0); // Red for pending
                }
                doc.text(isPaid ? 'PAID' : 'PENDING', x + 3, y + 5, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                
                // Draw row border
                doc.line(margin, y + rowHeight, pageWidth - margin, y + rowHeight);
                y += rowHeight;
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(
                    `Page ${i} of ${pageCount} | Generated on: ${formattedDate} at ${formattedTime}`,
                    pageWidth - margin,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'right' }
                );
            }
            
            // Save the PDF
            doc.save(`Order_History_${formattedDate.replace(/\//g, '-')}.pdf`);
        }
        
        function exportToExcel() {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            
            if (bills.length === 0) {
                showNotification('No bills to export', 'error');
                return;
            }
            
            // Prepare data for Excel
            const worksheet = XLSX.utils.json_to_sheet(bills.map(bill => {
                return {
                    'Bill No': bill.billNumber,
                    'Date': bill.billDate,
                    'Customer Name': bill.customerName,
                    'Mobile': bill.mobileNumber,
                    'Table No': bill.tableNumber || 'N/A',
                    'Items Count': bill.items.length,
                    'Subtotal': bill.subtotal,
                    'CGST': bill.cgstAmount,
                    'SGST': bill.sgstAmount,
                    'Total': typeof bill.finalTotal === 'number' ? bill.finalTotal : parseFloat(bill.finalTotal || 0),
                    'Status': bill.paymentStatus === 'pending' ? 'Pending' : 'Paid'
                };
            }));
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Bills');
            
            // Generate Excel file
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Bills_Export_${today}.xlsx`);
        }

        function exportToPDF() {
            const bills = JSON.parse(localStorage.getItem('bills') || '[]');
            
            if (bills.length === 0) {
                showNotification('No bills to export', 'error');
                return;
            }
            
            // Sort bills by date (newest first)
            bills.sort((a, b) => new Date(b.updatedAt || b.billDate) - new Date(a.updatedAt || a.billDate));
            
            // Calculate summary
            const totalAmount = bills.reduce((sum, bill) => sum + (parseFloat(bill.finalTotal) || 0), 0);
            const totalBills = bills.length;
            const paidBills = bills.filter(bill => bill.paymentStatus === 'paid').length;
            const pendingBills = totalBills - paidBills;
            
            // Generate PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 0;
            let page = 1;
            
            // Colors
            const colors = {
                primary: '#4e73df',
                success: '#1cc88a',
                danger: '#e74a3b',
                warning: '#f6c23e',
                dark: '#5a5c69',
                light: '#f8f9fc',
                border: '#e3e6f0',
                info: '#36b9cc'
            };
            
            // Add header function
            const addHeader = () => {
                // Company Logo and Info
                doc.setFillColor(colors.primary);
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);
                doc.text('RESTAURANT BILLING SYSTEM', pageWidth / 2, 15, { align: 'center' });
                
                // Report title
                doc.setFontSize(14);
                doc.text('ORDER HISTORY REPORT', pageWidth / 2, 22, { align: 'center' });
                
                // Date and time
                const now = new Date();
                const dateStr = now.toLocaleDateString();
                const timeStr = now.toLocaleTimeString();
                
                doc.setFontSize(9);
                doc.text(`Generated: ${dateStr} at ${timeStr}`, pageWidth - 10, 12, { align: 'right' });
                
                return 35; // Return Y position after header
            };
            
            // Add summary cards
            const addSummaryCards = (yPos) => {
                const cardHeight = 25;
                const cardWidth = (pageWidth - 50) / 4;
                
                // Total Bills Card
                doc.setFillColor(colors.primary);
                doc.roundedRect(15, yPos, cardWidth, cardHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.text(totalBills.toString(), 20, yPos + 15);
                doc.setFontSize(9);
                doc.text('TOTAL BILLS', 20, yPos + 20);
                
                // Total Amount Card
                doc.setFillColor(colors.success);
                doc.roundedRect(25 + cardWidth, yPos, cardWidth, cardHeight, 3, 3, 'F');
                doc.setFontSize(16);
                doc.text(`₹${totalAmount.toFixed(2)}`, 30 + cardWidth, yPos + 15);
                doc.setFontSize(9);
                doc.text('TOTAL AMOUNT', 30 + cardWidth, yPos + 20);
                
                // Paid Bills Card
                doc.setFillColor(colors.info);
                doc.roundedRect(35 + (cardWidth * 2), yPos, cardWidth, cardHeight, 3, 3, 'F');
                doc.setFontSize(20);
                doc.text(paidBills.toString(), 40 + (cardWidth * 2), yPos + 15);
                doc.setFontSize(9);
                doc.text('PAID BILLS', 40 + (cardWidth * 2), yPos + 20);
                
                // Pending Bills Card
                doc.setFillColor(colors.danger);
                doc.roundedRect(45 + (cardWidth * 3), yPos, cardWidth, cardHeight, 3, 3, 'F');
                doc.setFontSize(20);
                doc.text(pendingBills.toString(), 50 + (cardWidth * 3), yPos + 15);
                doc.setFontSize(9);
                doc.text('PENDING BILLS', 50 + (cardWidth * 3), yPos + 20);
                
                return yPos + cardHeight + 15;
            };
            
            // Add bill table
            const addBillTable = (yPos) => {
                // Table header
                doc.setFillColor(colors.light);
                doc.rect(15, yPos, pageWidth - 30, 10, 'F');
                doc.setDrawColor(colors.border);
                doc.rect(15, yPos, pageWidth - 30, 10);
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(colors.dark);
                
                const columns = [
                    { header: 'BILL NO', width: 25 },
                    { header: 'DATE', width: 30 },
                    { header: 'CUSTOMER', width: 40 },
                    { header: 'ITEMS', width: 20 },
                    { header: 'AMOUNT (₹)', width: 30 },
                    { header: 'STATUS', width: 25 }
                ];
                
                let x = 20;
                columns.forEach(col => {
                    doc.text(col.header, x, yPos + 7);
                    x += col.width;
                });
                
                yPos += 10;
                
                // Table rows
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                
                bills.forEach((bill, index) => {
                    // Check for page break
                    if (yPos > pageHeight - 30) {
                        // Add footer
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(`Page ${page}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                        
                        // Add new page
                        doc.addPage();
                        page++;
                        yPos = 20;
                        
                        // Add header on new page
                        doc.setFillColor(colors.primary);
                        doc.rect(0, 0, pageWidth, 25, 'F');
                        doc.setFontSize(14);
                        doc.setTextColor(255, 255, 255);
                        doc.text('ORDER HISTORY REPORT (Continued...)', pageWidth / 2, 15, { align: 'center' });
                        
                        // Reset styles for table
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        yPos = 40;
                        
                        // Add table header again
                        doc.setFillColor(colors.light);
                        doc.rect(15, yPos, pageWidth - 30, 10, 'F');
                        doc.setDrawColor(colors.border);
                        doc.rect(15, yPos, pageWidth - 30, 10);
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(colors.dark);
                        
                        let x = 20;
                        columns.forEach(col => {
                            doc.text(col.header, x, yPos + 7);
                            x += col.width;
                        });
                        
                        yPos += 10;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);
                    }
                    
                    // Format date
                    const billDate = new Date(bill.updatedAt || bill.billDate);
                    const formattedDate = billDate.toLocaleDateString('en-IN');
                    
                    // Alternate row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(colors.light);
                        doc.rect(15, yPos, pageWidth - 30, 10, 'F');
                    }
                    
                    // Add row data
                    doc.text(bill.billNumber, 20, yPos + 7);
                    doc.text(formattedDate, 50, yPos + 7);
                    
                    // Truncate long customer names
                    const customerName = bill.customerName.length > 20 ? 
                        bill.customerName.substring(0, 17) + '...' : bill.customerName;
                    doc.text(customerName, 85, yPos + 7);
                    
                    doc.text(bill.items.length.toString(), 130, yPos + 7);
                    
                    // Format amount
                    doc.text(`₹${parseFloat(bill.finalTotal).toFixed(2)}`, 150, yPos + 7);
                    
                    // Add status with color
                    const status = bill.paymentStatus === 'paid' ? 'PAID' : 'PENDING';
                    const statusColor = bill.paymentStatus === 'paid' ? colors.success : colors.danger;
                    
                    doc.setTextColor(statusColor);
                    doc.text(status, 180, yPos + 7);
                    doc.setTextColor(0, 0, 0); // Reset color
                    
                    yPos += 10;
                });
                
                return yPos + 10;
            };
            
            // Add footer function
            const addFooter = (yPos) => {
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Page ${page} of ${Math.ceil(bills.length / 20)}`, 
                        pageWidth / 2, pageHeight - 10, { align: 'center' });
                
                // Add watermark
                doc.setFontSize(60);
                doc.setTextColor(230, 230, 230);
                doc.text('SAMPLE', 105, 150, { angle: 45 });
                
                doc.setFontSize(8);
                doc.text('© ' + new Date().getFullYear() + ' Your Restaurant Name. All rights reserved.', 
                        pageWidth / 2, pageHeight - 5, { align: 'center' });
            };
            
            // Build the PDF
            y = addHeader();
            y = addSummaryCards(y);
            y = addBillTable(y);
            addFooter(y);
            
            // Save PDF
            const today = new Date().toISOString().split('T')[0];
            doc.save(`Order_History_${today}.pdf`);
        }

        // Helper function to show notifications
        function showNotification(message, type = 'info', duration = 5000) {
            // Check if notification container exists, if not create it
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.backgroundColor = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.marginBottom = '10px';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            notification.style.display = 'flex';
            notification.style.justifyContent = 'space-between';
            notification.style.alignItems = 'center';
            notification.style.minWidth = '300px';
            notification.style.maxWidth = '400px';
            notification.style.animation = 'slideIn 0.3s ease-out';
            
            // Add message
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notification.appendChild(messageSpan);
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.background = 'none';
            closeBtn.style.border = 'none';
            closeBtn.style.color = 'white';
            closeBtn.style.fontSize = '20px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.marginLeft = '10px';
            closeBtn.onclick = function() {
                notification.remove();
            };
            notification.appendChild(closeBtn);
            
            // Add to container
            container.appendChild(notification);
            
            // Auto remove after specified duration (default 5 seconds)
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Function to show save instructions modal
        function showSaveInstructionsModal(filename) {
            // Create modal container
            const modalContainer = document.createElement('div');
            modalContainer.id = 'saveInstructionsModal';
            modalContainer.style.position = 'fixed';
            modalContainer.style.top = '0';
            modalContainer.style.left = '0';
            modalContainer.style.width = '100%';
            modalContainer.style.height = '100%';
            modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modalContainer.style.display = 'flex';
            modalContainer.style.justifyContent = 'center';
            modalContainer.style.alignItems = 'center';
            modalContainer.style.zIndex = '10000';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '30px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
            modalContent.style.maxWidth = '600px';
            modalContent.style.width = '90%';
            
            // Create modal header
            const modalHeader = document.createElement('div');
            modalHeader.style.display = 'flex';
            modalHeader.style.justifyContent = 'space-between';
            modalHeader.style.alignItems = 'center';
            modalHeader.style.marginBottom = '20px';
            
            const modalTitle = document.createElement('h2');
            modalTitle.textContent = 'Save Bill PDF';
            modalTitle.style.margin = '0';
            modalTitle.style.color = '#2196F3';
            
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.color = '#555';
            closeButton.onclick = function() {
                document.body.removeChild(modalContainer);
            };
            
            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(closeButton);
            
            // Create modal body
            const modalBody = document.createElement('div');
            
            const instructionsTitle = document.createElement('h3');
            instructionsTitle.textContent = 'Please save the PDF to the following location:';
            instructionsTitle.style.marginTop = '0';
            
            const locationBox = document.createElement('div');
            locationBox.style.backgroundColor = '#f5f5f5';
            locationBox.style.padding = '15px';
            locationBox.style.borderRadius = '4px';
            locationBox.style.border = '1px solid #ddd';
            locationBox.style.marginBottom = '20px';
            locationBox.style.fontFamily = 'monospace';
            locationBox.style.fontSize = '14px';
            locationBox.textContent = 'C:\\Users\\bodkh\\OneDrive\\Desktop\\Ailexity Project\\Bill history';
            
            const filenameInfo = document.createElement('p');
            filenameInfo.innerHTML = `<strong>Filename:</strong> ${filename}`;
            
            const instructionsSteps = document.createElement('ol');
            instructionsSteps.style.paddingLeft = '20px';
            
            const steps = [
                'When the save dialog appears, navigate to the folder shown above.',
                'Make sure the filename remains unchanged to preserve the bill number and date information.',
                'Click "Save" to store the PDF in the specified location.'
            ];
            
            steps.forEach(step => {
                const listItem = document.createElement('li');
                listItem.textContent = step;
                listItem.style.marginBottom = '8px';
                instructionsSteps.appendChild(listItem);
            });
            
            const note = document.createElement('p');
            note.style.marginTop = '20px';
            note.style.padding = '10px';
            note.style.backgroundColor = '#fff9e6';
            note.style.border = '1px solid #ffe0b2';
            note.style.borderRadius = '4px';
            note.innerHTML = '<strong>Note:</strong> This will help maintain a backup of all your bills in a physical folder on your computer.';
            
            modalBody.appendChild(instructionsTitle);
            modalBody.appendChild(locationBox);
            modalBody.appendChild(filenameInfo);
            modalBody.appendChild(instructionsSteps);
            modalBody.appendChild(note);
            
            // Create modal footer
            const modalFooter = document.createElement('div');
            modalFooter.style.display = 'flex';
            modalFooter.style.justifyContent = 'flex-end';
            modalFooter.style.marginTop = '20px';
            
            const okButton = document.createElement('button');
            okButton.textContent = 'I understand';
            okButton.style.padding = '10px 20px';
            okButton.style.backgroundColor = '#2196F3';
            okButton.style.color = 'white';
            okButton.style.border = 'none';
            okButton.style.borderRadius = '4px';
            okButton.style.cursor = 'pointer';
            okButton.onclick = function() {
                document.body.removeChild(modalContainer);
            };
            
            modalFooter.appendChild(okButton);
            
            // Assemble modal
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);
            modalContainer.appendChild(modalContent);
            
            // Add to body
            document.body.appendChild(modalContainer);
        }

        // Add CSS for notification animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .modal-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                justify-content: flex-end;
            }
            .action-btn {
                padding: 8px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .print-btn {
                background-color: #2196F3;
                color: white;
            }
            .whatsapp-btn {
                background-color: #25D366;
                color: white;
            }
            .edit-btn {
                background-color: #FF9800;
                color: white;
            }
            .bill-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            .bill-detail-row {
                display: flex;
                gap: 10px;
            }
            .bill-detail-label {
                font-weight: 600;
                color: #555;
                min-width: 80px;
            }
        `;
        document.head.appendChild(style);

        // When user clicks outside the modal, close it
        window.onclick = function(event) {
            const modal = document.getElementById('billModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
